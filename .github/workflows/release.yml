name: Auto-Update Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update_repository:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Extract version from addon.xml
      id: get_version
      run: |
        VERSION=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('service.cloudsync/addon.xml'); print(tree.getroot().get('version'))")
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Found version: $VERSION"

        # Check if ZIP already exists
        if [ -f "service.cloudsync-${VERSION}.zip" ]; then
          echo "ZIP file already exists for version $VERSION"
          echo "SKIP_BUILD=true" >> $GITHUB_OUTPUT
        else
          echo "Need to build ZIP for version $VERSION"
          echo "SKIP_BUILD=false" >> $GITHUB_OUTPUT
        fi

    - name: Create addon ZIP and MD5
      if: steps.get_version.outputs.SKIP_BUILD == 'false'
      run: |
        # Create proper Kodi addon ZIP structure with addon folder inside
        mkdir -p temp_build/service.cloudsync
        cp -r service.cloudsync/* temp_build/service.cloudsync/

        # Remove any existing ZIP files from the copy
        find temp_build/service.cloudsync -name "*.zip" -delete
        find temp_build/service.cloudsync -name "*.md5" -delete

        # Create ZIP with proper structure (service.cloudsync/ folder inside)
        cd temp_build
        zip -r ../temp_addon.zip service.cloudsync -x "*.pyc" "*/__pycache__/*"
        cd ..

        # Create service.cloudsync directory if it doesn't exist
        mkdir -p service.cloudsync

        # Move ZIP to proper location
        mv temp_addon.zip service.cloudsync/service.cloudsync-${{ steps.get_version.outputs.VERSION }}.zip

        # Generate MD5 in proper location
        cd service.cloudsync
        md5sum service.cloudsync-${{ steps.get_version.outputs.VERSION }}.zip > service.cloudsync-${{ steps.get_version.outputs.VERSION }}.zip.md5
        cd ..

        # Clean up
        rm -rf temp_build

        echo "Created service.cloudsync/service.cloudsync-${{ steps.get_version.outputs.VERSION }}.zip (Kodi standard structure)"

    - name: Update addons.xml.md5
      run: |
        md5sum addons.xml | cut -d' ' -f1 > addons.xml.md5.temp
        echo " *addons.xml" >> addons.xml.md5.temp
        mv addons.xml.md5.temp addons.xml.md5
        echo "Updated addons.xml.md5"

    - name: Update repository.cloudsync files
      run: |
        if [ -d "repository.cloudsync" ]; then
          cp addons.xml repository.cloudsync/addons.xml
          cp addons.xml.md5 repository.cloudsync/addons.xml.md5
          echo "Updated repository.cloudsync files"
        fi

    - name: Commit and push all changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        git add -A
        if ! git diff --staged --quiet; then
          git commit -m "Auto-update repository for v${{ steps.get_version.outputs.VERSION }}"
          git push
          echo "Repository updated for version ${{ steps.get_version.outputs.VERSION }}"
        else
          echo "No changes to commit"
        fi

    - name: Create GitHub Release
      if: steps.get_version.outputs.SKIP_BUILD == 'false'
      run: |
        # Extract changelog from addons.xml
        CHANGELOG=$(python3 -c "
import xml.etree.ElementTree as ET
tree = ET.parse('addons.xml')
addon = tree.find('.//addon[@id=\"service.cloudsync\"]')
news = addon.find('.//news')
if news is not None and news.text:
    lines = [line.strip() for line in news.text.strip().split('\n') if line.strip()]
    for line in lines[:3]:  # First 3 changelog entries
        print('- ' + line)
")

        # Create release
        gh release create "v${{ steps.get_version.outputs.VERSION }}" \
          service.cloudsync/service.cloudsync-${{ steps.get_version.outputs.VERSION }}.zip \
          --title "CloudSync v${{ steps.get_version.outputs.VERSION }}" \
          --notes "## Changes
$CHANGELOG

## Installation
Download the ZIP file and install manually in Kodi, or install via [CloudSync Repository](https://github.com/fifthy52/kodi-cloudsync).

## Repository Installation
1. Download [repository.cloudsync.zip](https://github.com/fifthy52/kodi-cloudsync/raw/main/repository.cloudsync.zip)
2. Install in Kodi: Settings → Add-ons → Install from zip file"
      env:
        GH_TOKEN: ${{ github.token }}

